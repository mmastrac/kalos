import module;
import kidl;

var in_object = false;
var in_module = false;
var dispatch = "";
const FORWARD = "forward";
const IMPL = "impl";
const HANDLE = "handle";
const DISPATCH = "dispatch";
const OBJECT = "object";

handle open {
    println("/* Generated by kalos_idl_compiler - DO NOT MODIFY */");
    println("");
    println("#define K__string kalos_string*");
    println("#define K__number kalos_int");
    println("#define K__bool   kalos_int");
    println("#define K__object kalos_object*");
    println("#define K__any    kalos_value*");
    println("");
    println("#define K__t_string KALOS_VALUE_STRING");
    println("#define K__t_number KALOS_VALUE_NUMBER");
    println("#define K__t_bool   KALOS_VALUE_BOOL");
    println("#define K__t_object KALOS_VALUE_OBJECT");
    println("#define K__t_any    KALOS_VALUE_ANY");
    println("");
    println("#define K__arg(n, x)     peek(stack, (n)-(x))");
    println("#define K__arg_string(x) &((x)->value.string)");
    println("#define K__arg_number(x) (x)->value.number");
    println("#define K__arg_bool(x)   (x)->value.number");
    println("#define K__arg_object(x) (x)->value.object");
    println("#define K__arg_any(x)    (x)");
    println("");
    kidl.walk_modules(FORWARD);
    kidl.walk_modules(IMPL);
}

handle close {
    println("kalos_dispatch_fn {module.prefix}dispatch[] = {{");
    print(dispatch);
    println("}};");

    println("");
    println("#undef K__string");
    println("#undef K__number");
    println("#undef K__bool");
    println("#undef K__object");
    println("#undef K__any");
}

handle module.begin(context, m) {
    if (context == IMPL) {
        dispatch += "\t{m.prefix}{m.name},\n";
        module.walk_exports(HANDLE);
        println("void {m.prefix}{m.name}(kalos_state state, int function, kalos_stack* stack, bool retval) {{");
        println("\tswitch (function) {{");
        in_module = true;
        module.walk_exports(DISPATCH);
        in_module = false;
        println("\t}}");
        println("}}");
        println("");
    } else {
        module.walk_exports(FORWARD);
        #println("");
    }
}

handle module.handle_(context, handle_) {
    if (context != HANDLE) {
        return;
    }
    println("// id={handle_.module_index:04x}:{handle_.handle_index:04x} name={handle_.name}");
    if (module.name == "builtin") {
        print("void {module.prefix}trigger_{handle_.name}(kalos_state state");
    } else {
        print("void {module.prefix}{module.name}_trigger_{handle_.name}(kalos_state state");
    }
    var index = 0;
    var arg;
    for arg in handle_.args {
        print(", K__{arg} a{index}");
        index += 1;
    }
    println(") {{");
    index = 0;
    for arg in handle_.args {
        println("\tkalos_load_arg_{arg}(state, {index}, a{index});");
        index += 1;
    }
    println("\tkalos_trigger(state, kalos_make_address({handle_.module_index:#x}, {handle_.handle_index:#x}));");
    println("}}");
    println("");
}

handle module.object(context, object) {
    if (context != HANDLE) {
        return;
    }
    println("//{module.prefix}{module.name}_object_{object.name}_props");
    println("bool {module.prefix}{module.name}_object_{object.name}_props(kalos_state state, kalos_object* object, int function, kalos_stack* stack) {{");
    println("\tswitch (function) {{");
    in_object = true;
    module.walk_object_properties(OBJECT, object);
    in_object = false;
    println("\tdefault: return false;");
    println("\t}}");
    println("\treturn true;");
    println("}}");
    println("");
}

handle module.function(context, function) {
    if (context != DISPATCH) {
        return;
    }
    var arg;
    println("\t// id={function.id} name={function.name} arg_count={function.arg_count} symbol={function.realname}");
    println("\tcase {function.id}: {{");
    println("\t\tLOG(\"Invoke %s\", \"{function.name}\");");
    if (function.varargs == "void") {
        println("\t\tconst int arg_count = {function.arg_count};");
    } else {
        println("\t\tconst int vararg_count = kalos_stack_vararg_count(stack);");
        println("\t\tconst int arg_count = {function.arg_count + 1} + vararg_count;");
    }
    print("\t\tkalos_stack_setup_{function.arg_count}(stack");
    for arg in function.args {
        print(", K__t_{arg}");
    }
    println(");");
    print("\t\t");
    if (function.return_type == "string") {
        print("kalos_string x = ");
    } else if (function.return_type == "number" || function.return_type == "bool") {
        print("kalos_int x = ");
    } else if (function.return_type == "object") {
        print("kalos_object* x = ");
    } else if (function.return_type == "any") {
        print("kalos_value x = ");
    }
    var index = 0;
    print("{function.realname}(state");
    for arg in function.args {
        print(", K__arg_{arg}(K__arg(arg_count, {index+1}))");
        index += 1;
    }
    if (function.varargs != "void") {
        print(", vararg_count, kalos_stack_vararg_start(stack, vararg_count)");
    }
    println(");");
    println("\t\tkalos_stack_cleanup(arg_count, state, stack);");
    if (function.return_type != "void") {
        println("\t\tif (retval) {{");
        println("\t\t\tpush_{function.return_type}(stack, x);");
        if (function.return_type == "string") {
            println("\t\t}} else {{");
            println("\t\t\tkalos_string_release(state, x);");
        } else if (function.return_type == "object") {
            println("\t\t}} else {{");
            println("\t\t\tkalos_object_release(state, x);");
        } else if (function.return_type == "any") {
            println("\t\t}} else {{");
            println("\t\t\tkalos_clear(state, x);");
        }
        println("\t\t}}");
    }
    println("\t\tbreak;");
    println("\t}}");
    println("");
}

handle module.property(context, property) {
    if (!in_module && !in_object) {
        return;
    }
    var maybe_object = "";
    if (in_object) {
        maybe_object = ", object";
    }
    if (property.read_id != 0) {
        println("\t// id={property.read_id} name={property.name} symbol={property.read_symbol}");
        println("\tcase {property.read_id}: {{");
        println("\t\tpush_{property.type}(stack, {property.read_symbol}(state{maybe_object}));");
        println("\t\tbreak;");
        println("\t}}");
    }
    if (property.write_id != 0) {
        println("\t// id={property.write_id} name={property.name} symbol={property.write_symbol}");
        println("\tcase {property.write_id}: {{");
        #println("\t\tkalos_stack_fixup_no_varargs(1, stack);");
        println("\t\t{property.write_symbol}(state{maybe_object}, K__arg_{property.type}(K__arg(1, {1})));");
        #println("\t\tkalos_stack_cleanup_no_varargs(1, 0, state, stack);");
        println("\t\tkalos_stack_cleanup(1, state, stack);");
        println("\t\tbreak;");
        println("\t}}");
    }
}
